# CCG AutoPackaging

Encompasses API and backend-processing to generate / manage datapackages associated with boundaries

## API

API Covering boundaries, processors, packages and processing job submission against packages.

### Running Locally:

```bash
cd ccgautopkg
uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

Running using Docker:

```bash
docker-compose up api
```

### Documentation

#### OpenAPI

* Run the app as above
* Navigate to http://<host>:<port>/openapi.json

#### ReDoc

* Run the app as above
* Navigate to http://<host>:<port>/redoc

### Testing

Ensure the Celery Worker, Redis, PG and API service running are running somewhere (ideally in an isolated environment as assets will be generated by the tests) if you want to run the integration tests successfully.  Then update `INTEGRATION_TEST_ENDPOINT` in `api/config.py` to reflect the API host.

```bash
python -m unittest discover tests/dataproc
python -m unittest discover tests/api
```

### PG Schema Management with Alembic

The database schema is managed through Alembic.  The following serves as a guide to basic usage for extending the schema - refer to https://alembic.sqlalchemy.org/en/latest/ for more information.

#### Schema Updates

* Make changes as required to models
* From within the ccgautoppkg/api folder run the following to auto-generate an upgrade/downgrade script:

```bash
alembic revision --autogenerate -m "Added Boundary Table"
```

__NOTE__: CHECK the script - remove extransous operations (in particular those relating to spatial-ref-sys)

* When reaady run the following to upgrade the database:

```bash
alembic upgrade head
```