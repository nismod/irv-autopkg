# CCG AutoPackaging

Encompasses API and backend-processing to generate / manage datapackages associated with boundaries

## Data Processing

Celery-based worker running DAG's generated through API request

__TODO Docs__:

* Celery
* Dag structure
* Processors (Internal) - Boundary and Provenance 
* Processors (Core) - dev deployment and testing
* Secrets required for Processors
* Concurrency
* Duplicate Task submission and execution

### Running Locally:

```bash
cd ccgautopkg
celery --app dataproc.tasks worker --loglevel=debug --concurrency=1
```

Running using Docker:

```bash
docker-compose up dataproc
```

### Testing

Integration tests in `tests/dataproc/integration/processors` all run standalone (without Redis / Celery), but you'll need access to the source data for each processor (see above).

```bash
# Run tests locally
python -m unittest discover tests/dataproc
# Run tests in Docker
docker-compose run test-dataproc
```

## API

API Covering boundaries, processors, packages and processing job submission against packages.

### Running Locally:

```bash
cd ccgautopkg
uvicorn api.main:app --host 0.0.0.0 --port 8000
```

Running using Docker:

```bash
docker-compose up api
```

### Documentation

#### OpenAPI

* Run the app as above
* Navigate to http://<host>:<port>/openapi.json

#### ReDoc

* Run the app as above
* Navigate to http://<host>:<port>/redoc

### Testing

__NOTE__: API and Dataproc tests required access to shared processing and package folders for assertion of processor outputs.

__NOTE__: API tests will add and remove boundary test-data to/from the Db during execution.

__NOTE__: API tests will add and remove package data to/from the configured packages directory during execution.  Temporary processing data for `natural_earth_raster` will also be generated and removed from the configured processing backend folder.

__NOTE__: Dataproc will add and remove package data to/from the packages source tree during execution.  Processors will also remove data from their configured temporary processing directoryies, depenign on how they are configured.

__NOTE__: Individual processor integration tests require access to source data to run successfully.

#### Locally

Ensure the Celery Worker, Redis, PG and API service running are running somewhere (ideally in an isolated environment as assets will be generated by the tests) if you want to run the integration tests successfully.

Ensure you also have `CCGAUTOPKG_LOCALFS_STORAGE_BACKEND_ROOT_TEST` set in the environment, so both API and Celery worker can pickup the same package source tree

```bash
# Run API
export CCGAUTOPKG_DEPLOYMENT_ENV=test && uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload

# Run Worker 
export CCGAUTOPKG_DEPLOYMENT_ENV=test && celery --app dataproc.tasks worker --loglevel=debug --concurrency=1

# Run tests locally
python -m unittest discover tests/dataproc
python -m unittest discover tests/api
```

#### Docker

```bash
docker-compose up -d db redis api dataproc
docker-compose run test-api
```

### PG Schema Management with Alembic

The database schema is managed through Alembic.  The following serves as a guide to basic usage for extending the schema - refer to https://alembic.sqlalchemy.org/en/latest/ for more information.

#### Schema Updates

* Make changes as required to models
* From within the ccgautoppkg/api folder run the following to auto-generate an upgrade/downgrade script:

```bash
alembic revision --autogenerate -m "Added Boundary Table"
```

__NOTE__: CHECK the script - remove extransous operations (in particular those relating to spatial-ref-sys)

* When reaady run the following to upgrade the database:

```bash
alembic upgrade head
```

## Deployment Environment

```bash
export CCGAUTOPKG_POSTGRES_USER= # Used for API Boundaries only
export CCGAUTOPKG_POSTGRES_DB= # Used for API Boundaries only
export CCGAUTOPKG_POSTGRES_HOST= # Used for API Boundaries only
export CCGAUTOPKG_POSTGRES_PASSWORD= # Used for API Boundaries only
export CCGAUTOPKG_POSTGRES_PORT= # Used for API Boundaries only
export CCGAUTOPKG_CELERY_BROKER= # Used for Worker only
export CCGAUTOPKG_CELERY_BACKEND= # Used in API and Worker
export CCGAUTOPKG_STORAGE_BACKEND= # Storage backend to use for final packages (see additional backend-specific flags below for more info).  Used in API and Worker
export CCGAUTOPKG_LOCALFS_STORAGE_BACKEND_ROOT= # Path to root-directory for packages.  Used in API and Worker
export CCGAUTOPKG_LOCALFS_PROCESSING_BACKEND_ROOT= # Path to root-directory for local interim processing data.  Used by Worker only
export CCGAUTOPKG_LOCALFS_STORAGE_BACKEND_ROOT_TEST= # Path to root-directory for packages when running integration tests.  Used in API and Worker
export CCGAUTOPKG_LOCALFS_PROCESSING_BACKEND_ROOT_TEST= # Path to root-directory for local interim processing data when running integration tests.  Used by Worker only
```

### Local FileSystem Storage Backend

```bash
export CCGAUTOPKG_STORAGE_BACKEND=localfs
export CCGAUTOPKG_LOCALFS_STORAGE_BACKEND_ROOT=
export CCGAUTOPKG_LOCALFS_STORAGE_BACKEND_ROOT_TEST=
```